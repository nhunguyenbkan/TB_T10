<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minigame Ch·ªçn Ng√†y Tr·ª±c</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --card-width: 150px;
            --card-height: 200px;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .flip-card {
            background-color: transparent;
            width: var(--card-width);
            height: var(--card-height);
            perspective: 1000px;
            transition: opacity 0.3s;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-radius: 12px;
        }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .flip-card-front {
            background: linear-gradient(135deg, #2d338a 0%, #4f46e5 100%);
            color: white;
            border: 4px solid #2d338a;
            user-select: none;
        }
        .flip-card-back {
            background-color: white;
            color: #374151;
            transform: rotateY(180deg);
            border: 4px solid #06b6d4;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .selected-card {
            border: 4px solid #f97316;
            box-shadow: 0 0 25px rgba(249,115,22,0.6);
        }
        .flip-card.locked {
            pointer-events: none;
            cursor: default !important;
            opacity: 0.7;
        }
        .flip-card:not(.locked) { cursor: pointer; }
        @media (max-width: 640px) {
            :root { --card-width: 120px; --card-height: 160px; }
            .grid-cols-4 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-start min-h-screen">
    <div class="max-w-4xl w-full text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">üé∞ Minigame L·∫≠t Th·∫ª Ch·ªçn Ng√†y Tr·ª±c</h1>
        <p class="text-gray-500">Click v√†o m·ªôt th·∫ª b·∫•t k·ª≥ ƒë·ªÉ ch·ªçn ng√†y. Thao t√°c n√†y s·∫Ω kh√≥a t·∫•t c·∫£ c√°c th·∫ª c√≤n l·∫°i v√† g·ª≠i ƒëƒÉng k√Ω ngay l·∫≠p t·ª©c.</p>
    </div>

    <!-- User info -->
    <div class="w-full max-w-lg p-4 mb-6 bg-white border border-gray-200 rounded-xl shadow-lg mx-auto flex items-center space-x-4">
        <img id="user-avatar" class="w-12 h-12 rounded-full border-2 border-indigo-400" src="https://placehold.co/48x48/6366f1/ffffff?text=TG" alt="Avatar">
        <div>
            <span class="text-xs font-semibold text-gray-500">Ng∆∞·ªùi d√πng Telegram:</span>
            <p id="user-name" class="text-lg font-bold text-gray-800">ƒêang t·∫£i...</p>
        </div>
    </div>

    <!-- Cards container -->
    <div id="card-container" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-4 gap-4 sm:gap-6 md:gap-8 justify-center"></div>

    <!-- Message box -->
    <div class="mt-10 w-full max-w-lg p-6 bg-white border border-gray-200 rounded-xl shadow-lg mx-auto">
        <div id="message-box" class="p-3 text-sm rounded-lg text-blue-700 bg-blue-100" role="alert">
            Click v√†o th·∫ª b·∫°n mu·ªën l·∫≠t ƒë·ªÉ b·∫Øt ƒë·∫ßu ch·ªçn ng√†y.
        </div>
    </div>

    <script>
        const cardContainer = document.getElementById('card-container');
        const messageBox = document.getElementById('message-box');
        const userNameElement = document.getElementById('user-name');
        const userAvatarElement = document.getElementById('user-avatar');

        // Webhook URLs
        const webhookTestUrl = "https://nhunguyenbkan.app.n8n.cloud/webhook-test/941d3ada-5ac9-489b-be4a-c4a13d0d6c49";
        const webhookProdUrl = "https://nhunguyenbkan.app.n8n.cloud/webhook/941d3ada-5ac9-489b-be4a-c4a13d0d6c49";

        let selectedDate = null;
        let telegramUser = { id: 'mock_id_123', username: 'mock_user', first_name: 'Ng∆∞·ªùi d√πng' };

        function getTelegramInitData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const tgFirstName = urlParams.get('first_name') || 'Ng∆∞·ªùi d√πng Telegram';
                const tgUsername = urlParams.get('username');
                const tgId = urlParams.get('id') || 'N/A';
                const tgAvatarUrl = urlParams.get('avatar_url'); 

                if(tgId !== 'N/A') {
                    telegramUser = { id: tgId, username: tgUsername, first_name: tgFirstName };
                    userNameElement.textContent = tgFirstName + (tgUsername ? ` (@${tgUsername})` : '');
                    if(tgAvatarUrl) userAvatarElement.src = tgAvatarUrl;
                } else {
                    userNameElement.textContent = telegramUser.first_name + ' (Mock)';
                }
            } catch(e) {
                console.error("L·ªói Telegram Init:", e);
                userNameElement.textContent = telegramUser.first_name + ' (L·ªói t·∫£i)';
            }
        }

        function generateDates() {
            const days = ['Ch·ªß Nh·∫≠t','Th·ª© Hai','Th·ª© Ba','Th·ª© T∆∞','Th·ª© NƒÉm','Th·ª© S√°u','Th·ª© B·∫£y'];
            const dates = [];
            const now = new Date();
            for(let i=0;i<7;i++){
                const date = new Date(now);
                date.setDate(now.getDate() + i);
                const dayOfWeek = days[date.getDay()];
                const dateOnly = date.getDate();
                const monthOnly = date.getMonth() + 1;
                const year = date.getFullYear();
                const fullDate = `${year}-${String(monthOnly).padStart(2,'0')}-${String(dateOnly).padStart(2,'0')}`;
                dates.push({dayOfWeek,dateOnly,monthOnly,year,fullDate});
            }
            // shuffle
            for(let i=dates.length-1;i>0;i--){
                const j=Math.floor(Math.random()*(i+1));
                [dates[i],dates[j]]=[dates[j],dates[i]];
            }
            return dates;
        }

        function lockCardsFinal() {
            document.querySelectorAll('.flip-card').forEach(card=>{
                card.onclick=null;
                card.style.cursor='default';
            });
        }

        function handleCardClick(event) {
            const cardElement = event.currentTarget;
            if(cardElement.classList.contains('flipped') || cardElement.classList.contains('locked')) return;

            cardElement.classList.add('flipped');
            const innerCard = cardElement.querySelector('.flip-card-inner');
            document.querySelectorAll('.flip-card').forEach(card => card.classList.add('locked'));

            const dateValue = cardElement.getAttribute('data-date');
            const displayValue = cardElement.getAttribute('data-display');
            selectedDate = dateValue;
            innerCard.classList.add('selected-card');

            // POST payload to n8n webhook
            const payload = {
                action: "register_duty_day",
                date: selectedDate,
                user_id: telegramUser.id,
                user_name: telegramUser.first_name,
                full_telegram_info: JSON.stringify(telegramUser)
            };

            // Choose URL (test or production)
            const webhookUrl = webhookTestUrl; // ƒë·ªïi sang webhookProdUrl khi production

            fetch(webhookUrl, {
                method:'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => res.text())
            .then(data=>{
                console.log('Response from n8n webhook:', data);
                messageBox.classList.remove('text-blue-700','bg-blue-100');
                messageBox.classList.add('text-green-700','bg-green-100');
                messageBox.innerHTML = `‚úÖ <b>ƒêƒÇNG K√ù TH√ÄNH C√îNG!</b> B·∫°n ƒë√£ ch·ªçn ng√†y <b>${displayValue}</b>. D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c g·ª≠i v·ªÅ bot Telegram.`;
            })
            .catch(err=>{
                console.error('L·ªói g·ª≠i webhook:', err);
                messageBox.classList.remove('text-blue-700','bg-blue-100');
                messageBox.classList.add('text-red-700','bg-red-100');
                messageBox.innerHTML = `‚ùå C√≥ l·ªói x·∫£y ra khi g·ª≠i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.`;
            });

            lockCardsFinal();
        }

        function createCard(dateData){
            const card=document.createElement('div');
            card.className='flip-card';
            card.setAttribute('data-date',dateData.fullDate);
            card.setAttribute('data-display',`${dateData.dayOfWeek}, ${dateData.dateOnly}/${dateData.monthOnly}/${dateData.year}`);
            card.onclick = handleCardClick;

            card.innerHTML = `
                <div class="flip-card-inner">
                    <div class="flip-card-front">
                        <span class="text-7xl mb-2 font-bold transform -translate-y-2">?</span>
                        <span class="text-xl font-semibold">L·∫¨T TH·∫∫</span>
                        <span class="text-sm opacity-80 mt-1">Ch·ªçn ng√†y may m·∫Øn!</span>
                    </div>
                    <div class="flip-card-back">
                        <div class="flex flex-col items-center">
                            <span class="text-base font-medium text-gray-500">${dateData.dayOfWeek}</span>
                            <span class="text-6xl font-extrabold text-indigo-600">${dateData.dateOnly}</span>
                            <span class="text-xl font-semibold text-gray-700 mt-1">${dateData.monthOnly}/${dateData.year}</span>
                            <span class="text-xs text-green-600 mt-2">Ng√†y ƒë√£ ch·ªçn!</span>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }

        window.onload = function(){
            getTelegramInitData();
            const dates = generateDates();
            dates.forEach(dateData=>{
                const card=createCard(dateData);
                cardContainer.appendChild(card);
            });
        }
    </script>
</body>
</html>

