<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·ªëc ThƒÉm Tu·∫ßn</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght=400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --card-width: 150px;
            --card-height: 200px;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        
        /* Responsive Grid cho Th·∫ª (Card Grid) */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(2, var(--card-width)); 
            gap: 16px; 
            justify-content: center; 
            max-width: 100%;
        }
        
        /* Tablet tr·ªü l√™n: 3 c·ªôt */
        @media (min-width: 640px) { 
             .card-grid {
                grid-template-columns: repeat(3, var(--card-width));
                gap: 24px;
             }
             :root { --card-width: 130px; --card-height: 180px; }
        }
        
        /* Desktop/M√†n h√¨nh l·ªõn: 4 c·ªôt */
        @media (min-width: 768px) { 
             .card-grid {
                grid-template-columns: repeat(4, var(--card-width));
                gap: 32px;
             }
             :root { --card-width: 150px; --card-height: 200px; }
        }
        
        /* Card Flip Animation */
        .flip-card {
            background-color: transparent;
            width: var(--card-width);
            height: var(--card-height);
            perspective: 1000px;
            transition: opacity 0.3s, transform 0.3s;
            cursor: pointer;
            box-sizing: border-box;
        }
        .flip-card:not(.locked):hover {
            transform: scale(1.05); 
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            transform-style: preserve-3d;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            border-radius: 12px;
        }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 8px; 
        }
        .flip-card-front {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); 
            color: white;
            border: 4px solid #1e3a8a;
            user-select: none;
        }
        .flip-card-back {
            background-color: white;
            color: #1f2937;
            transform: rotateY(180deg);
            border: 4px solid #0ea5e9;
        }
        .selected-card {
            border-color: #f97316 !important; 
            box-shadow: 0 0 30px rgba(249,115,22,0.8);
        }
        .flip-card.locked {
            pointer-events: none;
            cursor: default !important;
            opacity: 0.5;
            transform: none !important;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-start min-h-screen">
    <div class="max-w-4xl w-full text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">üéØ B·ªëc ThƒÉm Tu·∫ßn - 7 Phi·∫øu Chung</h1>
        <p class="text-gray-500">Click v√†o m·ªôt th·∫ª b·∫•t k·ª≥ ƒë·ªÉ ch·ªçn Index. Thao t√°c n√†y s·∫Ω kh√≥a t·∫•t c·∫£ c√°c th·∫ª c√≤n l·∫°i v√† g·ª≠i k·∫øt qu·∫£ ngay l·∫≠p t·ª©c.</p>
    </div>

    <div class="w-full max-w-lg p-4 mb-6 bg-white border border-gray-200 rounded-xl shadow-lg mx-auto flex items-center space-x-4">
        <img id="user-avatar" class="w-12 h-12 rounded-full border-2 border-indigo-400" src="" alt="Avatar">
        <div>
            <span class="text-xs font-semibold text-gray-500">Ng∆∞·ªùi d√πng Telegram:</span>
            <p id="user-name" class="text-lg font-bold text-gray-800">ƒêang t·∫£i...</p>
            <p id="user-id" class="text-xs text-gray-500">ID: ƒêang t·∫£i...</p>
        </div>
    </div>

    <div class="w-full max-w-lg p-4 mb-6 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl shadow-lg mx-auto text-center">
        <div class="text-sm font-semibold opacity-80">TU·∫¶N L√ÄM VI·ªÜC</div>
        <div id="week-range" class="text-xl font-bold">ƒêang t·∫£i...</div>
    </div>

    <div id="card-container" class="card-grid"></div>

    <div id="result-section" class="mt-6 w-full max-w-lg p-6 bg-white border border-gray-200 rounded-xl shadow-lg mx-auto hidden">
        <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">üéä K·∫æT QU·∫¢ B·ªêC THƒÇM</h3>
        <div class="space-y-3">
            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                <span class="font-semibold text-gray-700">üéØ Index ƒë√£ ch·ªçn:</span>
                <span id="result-index" class="text-xl font-bold text-blue-600">-</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                <span class="font-semibold text-gray-700">üìÖ Ng√†y t∆∞∆°ng ·ª©ng:</span>
                <span id="result-date" class="text-lg font-bold text-green-600">-</span>
            </div>
        </div>
    </div>

    <div class="mt-6 w-full max-w-lg p-6 bg-white border border-gray-200 rounded-xl shadow-lg mx-auto">
        <div id="message-box" class="p-3 text-sm rounded-lg text-blue-700 bg-blue-100" role="alert">
            Click v√†o m·ªôt th·∫ª b·∫•t k·ª≥ ƒë·ªÉ b·ªëc thƒÉm Index.
        </div>
    </div>

    <script>
        // === KHAI B√ÅO BI·∫æN DOM ===
        const cardContainer = document.getElementById('card-container');
        const messageBox = document.getElementById('message-box');
        const userNameElement = document.getElementById('user-name');
        const userAvatarElement = document.getElementById('user-avatar');
        const userIdElement = document.getElementById('user-id');
        const weekRangeElement = document.getElementById('week-range');
        const resultSection = document.getElementById('result-section');
        const resultIndexElement = document.getElementById('result-index');
        const resultDateElement = document.getElementById('result-date');

        // === BI·∫æN TR·∫†NG TH√ÅI ===
        let selectedIndex = null;
        let telegramUser = null;
        let weekDates = {};
        let cardsInitialized = false;
        let storageKey = ''; // S·∫Ω ƒë∆∞·ª£c g√°n sau khi t√≠nh to√°n weekDates

        // === FUNCTION CHU·∫®N H√ìA NG√ÄY TH√ÅNG ===
        function formatDate(date) {
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit'
            });
        }
        
        // === FUNCTION T√çNH TO√ÅN NG√ÄY M·ªêC ===
        function getTriggerDateFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const triggerDateISO = urlParams.get('trigger_date');
            
            if (triggerDateISO) {
                const date = new Date(triggerDateISO);
                return isNaN(date.getTime()) ? new Date() : date;
            } else {
                return new Date();
            }
        }

        // === FUNCTION T√çNH TO√ÅN TU·∫¶N L√ÄM VI·ªÜC (Th·ª© Hai Tu·∫ßn K·∫ø Ti·∫øp) ===
        function calculateWeekFromTriggerDate(triggerDate) {
            const daysOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const week = {};
            
            const currentDay = new Date(triggerDate); 
            
            // 1. T√¨m ng√†y Th·ª© Hai c·ªßa tu·∫ßn HI·ªÜN T·∫†I
            let dayIndex = currentDay.getDay(); 
            const daysToMonday = (dayIndex === 0) ? 6 : dayIndex - 1;
            currentDay.setDate(currentDay.getDate() - daysToMonday); 

            // 2. Chuy·ªÉn sang Th·ª© Hai c·ªßa tu·∫ßn K·∫æ TI·∫æP
            currentDay.setDate(currentDay.getDate() + 7);
            
            // 3. L·∫∑p qua 7 ng√†y, b·∫Øt ƒë·∫ßu t·ª´ Th·ª© Hai c·ªßa tu·∫ßn k·∫ø ti·∫øp
            for (let i = 0; i < 7; i++) {
                const dayKey = daysOfWeek[(i + 1) % 7]; 
                week[dayKey] = formatDate(currentDay); 
                currentDay.setDate(currentDay.getDate() + 1); 
            }
            
            const orderedDates = [
                week.monday, week.tuesday, week.wednesday, week.thursday, 
                week.friday, week.saturday, week.sunday
            ];
            
            return {
                dates: orderedDates, 
                week_range: `${orderedDates[0]} - ${orderedDates[6]}`
            };
        }

        // === FUNCTION T·∫†O V√Ä X√ÅO TR·ªòN TH·∫∫ ===
        function generateIndexCards() {
            const days = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'Ch·ªß Nh·∫≠t'];
            const cards = [];
            
            // T·∫°o 7 th·∫ª, g√°n ng√†y th√°ng ƒë√£ t√≠nh to√°n theo th·ª© t·ª± T2 -> CN
            for (let i = 0; i < 7; i++) {
                cards.push({
                    index: i + 1,
                    day: days[i],
                    date: weekDates.dates[i] || 'N/A'
                });
            }
            
            // L·∫•y th·ª© t·ª± x√°o tr·ªôn c≈© n·∫øu c√≥ (ch·ªâ l·∫ßn ƒë·∫ßu ti√™n t·∫°o card)
            if (!cardsInitialized) {
                const savedResult = getSavedResult();
                let shuffledCards = cards;
                
                if (savedResult && savedResult.shuffledCards) {
                    // N·∫øu c√≥ k·∫øt qu·∫£ c≈©, s·ª≠ d·ª•ng th·ª© t·ª± x√°o tr·ªôn c≈©
                    shuffledCards = savedResult.shuffledCards;
                    console.log('Using saved card order.');
                } else {
                    // N·∫øu ch∆∞a c√≥, x√°o tr·ªôn m·ªõi
                    for(let i = cards.length - 1; i > 0; i--){
                        const j = Math.floor(Math.random() * (i + 1));
                        [cards[i], cards[j]] = [cards[j], cards[i]];
                    }
                    console.log('New card order generated.');
                }
                
                return shuffledCards;
            }
            // Tr∆∞·ªùng h·ª£p n√†y kh√¥ng n√™n x·∫£y ra n·∫øu logic initializeCards ƒë√∫ng
            return cards;
        }

        // === FUNCTION L∆ØU V√Ä L·∫§Y K·∫æT QU·∫¢ T·ª™ LOCALSTORAGE ===
        function getSavedResult() {
            try {
                const saved = localStorage.getItem(storageKey);
                return saved ? JSON.parse(saved) : null;
            } catch (e) {
                console.error('Error reading localStorage:', e);
                return null;
            }
        }

        function saveResult(selectedIndex, selectedDay, selectedDate, shuffledCards) {
            const result = {
                selectedIndex: selectedIndex,
                selectedDay: selectedDay,
                selectedDate: selectedDate,
                shuffledCards: shuffledCards // L∆∞u tr·ªØ th·ª© t·ª± th·∫ª
            };
            try {
                localStorage.setItem(storageKey, JSON.stringify(result));
            } catch (e) {
                console.error('Error writing localStorage:', e);
            }
        }
        
        function displaySavedResult(savedResult) {
            // L·∫≠t v√† kh√≥a th·∫ª ƒë√£ ch·ªçn
            const selectedCardElement = document.querySelector(`.flip-card[data-index="${savedResult.selectedIndex}"]`);
            if (selectedCardElement) {
                selectedCardElement.classList.add('flipped');
                selectedCardElement.querySelector('.flip-card-inner').classList.add('selected-card');
            }

            // Kh√≥a t·∫•t c·∫£ c√°c th·∫ª
            document.querySelectorAll('.flip-card').forEach(card => card.classList.add('locked'));
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            resultIndexElement.textContent = savedResult.selectedIndex;
            resultDateElement.textContent = `${savedResult.selectedDay} (${savedResult.selectedDate})`;
            resultSection.classList.remove('hidden');

            // Hi·ªÉn th·ªã th√¥ng b√°o
            messageBox.classList.remove('text-blue-700', 'bg-blue-100');
            messageBox.classList.add('text-green-700', 'bg-green-100');
            messageBox.innerHTML = `üåü <b>ƒê√É B·ªêC THƒÇM!</b> K·∫øt qu·∫£ Index <b>${savedResult.selectedIndex}</b> ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n v√†o tu·∫ßn n√†y.`;
        }

        // === FUNCTION T·∫†O C·∫§U TR√öC TH·∫∫ HTML ===
        function createCard(cardData) {
            const card = document.createElement('div');
            card.className = 'flip-card';
            card.setAttribute('data-index', cardData.index);
            card.setAttribute('data-day', cardData.day);
            card.setAttribute('data-date', cardData.date);
            card.onclick = handleCardClick;

            card.innerHTML = `
                <div class="flip-card-inner">
                    <div class="flip-card-front">
                        <span class="text-7xl mb-2 font-bold transform -translate-y-2">?</span>
                        <span class="text-xl font-semibold">L·∫¨T TH·∫∫</span>
                        <span class="text-sm opacity-80 mt-1">Ch·ªçn index may m·∫Øn!</span>
                    </div>
                    <div class="flip-card-back">
                        <div class="flex flex-col items-center">
                            <span class="text-base font-medium text-gray-500">${cardData.day}</span>
                            <span class="text-6xl font-extrabold text-indigo-600">${cardData.index}</span>
                            <span class="text-lg font-semibold text-gray-700 mt-1">${cardData.date}</span>
                            <span class="text-xs text-green-600 mt-2">Index ƒë√£ ch·ªçn!</span>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }
        
        // ... (C√°c h√†m initTelegramWebApp, updateUserInfo, showFallbackUserInfo gi·ªØ nguy√™n)

        function initTelegramWebApp() {
            return new Promise((resolve) => {
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    tg.ready();
                    
                    setTimeout(() => {
                        const user = tg.initDataUnsafe.user;
                        
                        if (user) {
                            telegramUser = {
                                id: user.id || 'unknown',
                                first_name: user.first_name || 'Ng∆∞·ªùi d√πng',
                                last_name: user.last_name || '',
                                username: user.username || '',
                                language_code: user.language_code || 'vi',
                                is_premium: user.is_premium || false
                            };
                        } else {
                            showFallbackUserInfo();
                        }
                        
                        updateUserInfo();
                        tg.expand();
                        resolve(true);
                    }, 100);
                } else {
                    showFallbackUserInfo();
                    resolve(false); 
                }
            });
        }

        function updateUserInfo() {
            const fullName = `${telegramUser.first_name} ${telegramUser.last_name}`.trim();
            userNameElement.textContent = fullName + (telegramUser.username ? ` (@${telegramUser.username})` : '');
            userIdElement.textContent = `ID: ${telegramUser.id}`;
            
            const avatarUrl = window.Telegram?.WebApp?.initDataUnsafe?.user?.photo_url 
                              || `https://ui-avatars.com/api/?name=${encodeURIComponent(telegramUser.first_name || 'U')}&background=6366f1&color=fff`;
            userAvatarElement.src = avatarUrl;
        }

        function showFallbackUserInfo() {
            telegramUser = {
                id: 'unknown_local',
                first_name: 'Ng∆∞·ªùi d√πng ƒë·ªãa ph∆∞∆°ng',
                last_name: '',
                username: '',
                language_code: 'vi',
                is_premium: false
            };
        }

        // === FUNCTION X·ª¨ L√ù CLICK V√Ä G·ª¨I WEBHOOK ===
        function handleCardClick(event) {
            const cardElement = event.currentTarget;
            // L·∫•y t·∫•t c·∫£ th√¥ng tin th·∫ª hi·ªán t·∫°i (ƒë√£ x√°o tr·ªôn) ƒë·ªÉ l∆∞u tr·ªØ
            const currentShuffledCards = Array.from(document.querySelectorAll('.flip-card')).map(el => ({
                index: parseInt(el.getAttribute('data-index')),
                day: el.getAttribute('data-day'),
                date: el.getAttribute('data-date')
            }));

            if(cardElement.classList.contains('flipped') || cardElement.classList.contains('locked')) return;

            cardElement.classList.add('flipped');
            const innerCard = cardElement.querySelector('.flip-card-inner');
            document.querySelectorAll('.flip-card').forEach(card => card.classList.add('locked'));

            selectedIndex = parseInt(cardElement.getAttribute('data-index'));
            const selectedDay = cardElement.getAttribute('data-day');
            const selectedDate = cardElement.getAttribute('data-date');
            
            innerCard.classList.add('selected-card');
            
            // ‚≠êÔ∏è B∆Ø·ªöC M·ªöI: L∆ØU K·∫æT QU·∫¢ V√ÄO LOCALSTORAGE TR∆Ø·ªöC KHI G·ª¨I
            saveResult(selectedIndex, selectedDay, selectedDate, currentShuffledCards);

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            resultIndexElement.textContent = selectedIndex;
            resultDateElement.textContent = `${selectedDay} (${selectedDate})`;
            resultSection.classList.remove('hidden');

            // Hi·ªÉn th·ªã loading
            messageBox.classList.remove('text-blue-700', 'bg-blue-100', 'text-green-700', 'bg-green-100');
            messageBox.classList.add('text-yellow-700', 'bg-yellow-100');
            messageBox.innerHTML = `‚è≥ <b>ƒêANG G·ª¨I K·∫æT QU·∫¢...</b> Vui l√≤ng ch·ªù.`;

            // URL Webhook PRODUCTION c·ªßa b·∫°n
            const webhookUrl = "https://nhunguyenbkan.app.n8n.cloud/webhook/34276555-fab1-466c-afd7-bea2bf7a38f0"; 
            
            const payload = {
                action: "lottery_selection",
                selected_index: selectedIndex,
                selected_day: selectedDay,
                selected_date: selectedDate,
                week_range: weekDates.week_range,
                user_id: telegramUser.id,
                user_first_name: telegramUser.first_name,
                user_last_name: telegramUser.last_name,
                user_username: telegramUser.username,
                trigger_date: getTriggerDateFromURL().toISOString(),
                timestamp: new Date().toISOString(),
                source: 'telegram_web_app_v4_with_storage'
            };

            fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! Status: ${res.status}. Vui l√≤ng ki·ªÉm tra N8N.`);
                }
                return res.text();
            })
            .then(data => {
                console.log('Response from n8n webhook:', data);
                messageBox.classList.remove('text-yellow-700', 'bg-yellow-100', 'text-red-700', 'bg-red-100');
                messageBox.classList.add('text-green-700', 'bg-green-100');
                messageBox.innerHTML = `‚úÖ <b>B·ªêC THƒÇM TH√ÄNH C√îNG!</b> Index <b>${selectedIndex}</b> - ${selectedDay} ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.`;
                
                setTimeout(() => {
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.close();
                    }
                }, 3000);
            })
            .catch(err => {
                messageBox.classList.remove('text-yellow-700', 'bg-yellow-100', 'text-green-700', 'bg-green-100');
                messageBox.classList.add('text-red-700', 'bg-red-100');
                messageBox.innerHTML = `‚ùå C√≥ l·ªói x·∫£y ra khi g·ª≠i d·ªØ li·ªáu: <b>${err.message}</b>. Vui l√≤ng ch·ª•p m√†n h√¨nh v√† b√°o l·∫°i!`;
            });
        }

        // === KH·ªûI T·∫†O CH√çNH ===
        function initializeCards() {
            if (cardsInitialized) return;
            
            // 1. T√≠nh to√°n v√† hi·ªÉn th·ªã tu·∫ßn
            const triggerDate = getTriggerDateFromURL();
            const weekData = calculateWeekFromTriggerDate(triggerDate);
            weekDates = weekData;
            weekRangeElement.textContent = weekData.week_range;
            
            // 2. G√°n Storage Key d·ª±a tr√™n tu·∫ßn
            // Vi·ªác th√™m weekDates.week_range v√†o key gi√∫p tr√°nh nh·∫ßm l·∫´n k·∫øt qu·∫£ gi·ªØa c√°c tu·∫ßn
            storageKey = 'lottery_result_' + weekDates.week_range.replace(/\s/g, '_'); 

            // 3. Ki·ªÉm tra k·∫øt qu·∫£ c≈©
            const savedResult = getSavedResult();
            
            // 4. T·∫°o v√† hi·ªÉn th·ªã cards
            // H√†m generateIndexCards() s·∫Ω s·ª≠ d·ª•ng th·ª© t·ª± c≈© n·∫øu savedResult t·ªìn t·∫°i
            const indexCards = generateIndexCards(); 
            
            indexCards.forEach(cardData => {
                const card = createCard(cardData);
                cardContainer.appendChild(card);
            });
            
            cardsInitialized = true;
            
            // 5. N·∫øu c√≥ k·∫øt qu·∫£ c≈©, hi·ªÉn th·ªã n√≥ ngay l·∫≠p t·ª©c
            if (savedResult) {
                displaySavedResult(savedResult);
            }
        }

        async function initializeApp() {
            await initTelegramWebApp();
            initializeCards();
            console.log('App initialized successfully');
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
