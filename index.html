<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·ªëc ThƒÉm Tu·∫ßn - 7 Phi·∫øu Chung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --card-width: 150px;
            --card-height: 200px;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .flip-card {
            background-color: transparent;
            width: var(--card-width);
            height: var(--card-height);
            perspective: 1000px;
            transition: opacity 0.3s;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-radius: 12px;
        }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .flip-card-front {
            background: linear-gradient(135deg, #2d338a 0%, #4f46e5 100%);
            color: white;
            border: 4px solid #2d338a;
            user-select: none;
        }
        .flip-card-back {
            background-color: white;
            color: #374151;
            transform: rotateY(180deg);
            border: 4px solid #06b6d4;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .selected-card {
            border: 4px solid #f97316;
            box-shadow: 0 0 25px rgba(249,115,22,0.6);
        }
        .flip-card.locked {
            pointer-events: none;
            cursor: default !important;
            opacity: 0.7;
        }
        .flip-card:not(.locked) { cursor: pointer; }
        @media (max-width: 640px) {
            :root { --card-width: 120px; --card-height: 160px; }
            .grid-cols-4 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-start min-h-screen">
    <div class="max-w-4xl w-full text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">üéØ B·ªëc ThƒÉm Tu·∫ßn - 7 Phi·∫øu Chung</h1>
        <p class="text-gray-500">Click v√†o m·ªôt th·∫ª b·∫•t k·ª≥ ƒë·ªÉ ch·ªçn Index. Thao t√°c n√†y s·∫Ω kh√≥a t·∫•t c·∫£ c√°c th·∫ª c√≤n l·∫°i v√† g·ª≠i k·∫øt qu·∫£ ngay l·∫≠p t·ª©c.</p>
    </div>

    <!-- User info -->
    <div class="w-full max-w-lg p-4 mb-6 bg-white border border-gray-200 rounded-xl shadow-lg mx-auto flex items-center space-x-4">
        <img id="user-avatar" class="w-12 h-12 rounded-full border-2 border-indigo-400" src="" alt="Avatar">
        <div>
            <span class="text-xs font-semibold text-gray-500">Ng∆∞·ªùi d√πng Telegram:</span>
            <p id="user-name" class="text-lg font-bold text-gray-800">ƒêang t·∫£i...</p>
            <p id="user-id" class="text-xs text-gray-500">ID: ƒêang t·∫£i...</p>
        </div>
    </div>

    <!-- Week Range Display -->
    <div class="w-full max-w-lg p-4 mb-6 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl shadow-lg mx-auto text-center">
        <div class="text-sm font-semibold opacity-80">TU·∫¶N L√ÄM VI·ªÜC</div>
        <div id="week-range" class="text-xl font-bold">ƒêang t·∫£i...</div>
    </div>

    <!-- Cards container -->
    <div id="card-container" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-4 gap-4 sm:gap-6 md:gap-8 justify-center"></div>

    <!-- Result Display -->
    <div id="result-section" class="mt-6 w-full max-w-lg p-6 bg-white border border-gray-200 rounded-xl shadow-lg mx-auto hidden">
        <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">üéä K·∫æT QU·∫¢ B·ªêC THƒÇM</h3>
        <div class="space-y-3">
            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                <span class="font-semibold text-gray-700">üéØ Index ƒë√£ ch·ªçn:</span>
                <span id="result-index" class="text-xl font-bold text-blue-600">-</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                <span class="font-semibold text-gray-700">üìÖ Ng√†y t∆∞∆°ng ·ª©ng:</span>
                <span id="result-date" class="text-lg font-bold text-green-600">-</span>
            </div>
        </div>
    </div>

    <!-- Message box -->
    <div class="mt-6 w-full max-w-lg p-6 bg-white border border-gray-200 rounded-xl shadow-lg mx-auto">
        <div id="message-box" class="p-3 text-sm rounded-lg text-blue-700 bg-blue-100" role="alert">
            Click v√†o m·ªôt th·∫ª b·∫•t k·ª≥ ƒë·ªÉ b·ªëc thƒÉm Index.
        </div>
    </div>

    <script>
        const cardContainer = document.getElementById('card-container');
        const messageBox = document.getElementById('message-box');
        const userNameElement = document.getElementById('user-name');
        const userAvatarElement = document.getElementById('user-avatar');
        const userIdElement = document.getElementById('user-id');
        const weekRangeElement = document.getElementById('week-range');
        const resultSection = document.getElementById('result-section');
        const resultIndexElement = document.getElementById('result-index');
        const resultDateElement = document.getElementById('result-date');

        // WEBHOOK URL C·ª¶A B·∫†N
        const webhookUrl = "https://nhunguyenbkan.app.n8n.cloud/webhook-test/34276554-fab1-466c-afd7-bea2bf7a38f0";

        let selectedIndex = null;
        let telegramUser = null;
        let weekDates = {};
        let cardsInitialized = false;

        // Kh·ªüi t·∫°o Telegram Web App - S·ª¨A L·∫†I
        function initTelegramWebApp() {
            return new Promise((resolve) => {
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    
                    // ƒê·ª£i Telegram Web App s·∫µn s√†ng
                    tg.ready();
                    
                    // Th√™m timeout ƒë·ªÉ ƒë·∫£m b·∫£o
                    setTimeout(() => {
                        // L·∫•y th√¥ng tin user t·ª´ Telegram
                        const user = tg.initDataUnsafe.user;
                        
                        if (user) {
                            telegramUser = {
                                id: user.id,
                                first_name: user.first_name,
                                last_name: user.last_name || '',
                                username: user.username || '',
                                language_code: user.language_code || 'vi',
                                is_premium: user.is_premium || false
                            };
                            
                            // Hi·ªÉn th·ªã th√¥ng tin user
                            updateUserInfo();
                            console.log('Telegram User loaded:', telegramUser);
                        } else {
                            // Fallback n·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin user
                            showFallbackUserInfo();
                        }
                        
                        // M·ªü r·ªông web app
                        tg.expand();
                        resolve(true);
                    }, 100);
                } else {
                    // Fallback cho m√¥i tr∆∞·ªùng kh√¥ng ph·∫£i Telegram
                    showFallbackUserInfo();
                    resolve(true);
                }
            });
        }

        function updateUserInfo() {
            userNameElement.textContent = `${telegramUser.first_name} ${telegramUser.last_name}`.trim();
            if (telegramUser.username) {
                userNameElement.textContent += ` (@${telegramUser.username})`;
            }
            
            userIdElement.textContent = `ID: ${telegramUser.id}`;
            
            // C·ªë g·∫Øng l·∫•y avatar (n·∫øu c√≥)
            if (window.Telegram?.WebApp?.initDataUnsafe?.user?.photo_url) {
                userAvatarElement.src = window.Telegram.WebApp.initDataUnsafe.user.photo_url;
            } else {
                // T·∫°o avatar m·∫∑c ƒë·ªãnh d·ª±a tr√™n t√™n
                userAvatarElement.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(telegramUser.first_name)}&background=6366f1&color=fff`;
            }
        }

        function showFallbackUserInfo() {
            telegramUser = {
                id: 'unknown',
                first_name: 'Ng∆∞·ªùi d√πng Telegram',
                last_name: '',
                username: '',
                language_code: 'vi',
                is_premium: false
            };
            
            updateUserInfo();
        }

        // L·∫•y trigger date t·ª´ URL parameter v√† t√≠nh to√°n tu·∫ßn
        function getTriggerDateFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const triggerDateISO = urlParams.get('trigger_date');
            
            if (triggerDateISO) {
                return new Date(triggerDateISO);
            } else {
                // Fallback: d√πng ng√†y hi·ªán t·∫°i v√† t√¨m th·ª© 6 g·∫ßn nh·∫•t
                const now = new Date();
                const dayOfWeek = now.getDay();
                const daysToFriday = dayOfWeek <= 5 ? 5 - dayOfWeek : 5 - dayOfWeek + 7;
                const friday = new Date(now);
                friday.setDate(now.getDate() + daysToFriday);
                return friday;
            }
        }

        function calculateWeekFromTriggerDate(triggerDate) {
            const friday = new Date(triggerDate);
            
            const monday = new Date(friday);
            monday.setDate(friday.getDate() - 4);
            
            const tuesday = new Date(friday);
            tuesday.setDate(friday.getDate() - 3);
            
            const wednesday = new Date(friday);
            wednesday.setDate(friday.getDate() - 2);
            
            const thursday = new Date(friday);
            thursday.setDate(friday.getDate() - 1);
            
            const saturday = new Date(friday);
            saturday.setDate(friday.getDate() + 1);
            
            const sunday = new Date(friday);
            sunday.setDate(friday.getDate() + 2);
            
            return {
                monday: formatDate(monday),
                tuesday: formatDate(tuesday),
                wednesday: formatDate(wednesday),
                thursday: formatDate(thursday),
                friday: formatDate(friday),
                saturday: formatDate(saturday),
                sunday: formatDate(sunday),
                week_range: `${formatDate(monday)} - ${formatDate(sunday)}`
            };
        }

        function formatDate(date) {
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit'
            });
        }

        function generateIndexCards() {
            const days = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'Ch·ªß Nh·∫≠t'];
            const cards = [];
            
            for (let i = 1; i <= 7; i++) {
                cards.push({
                    index: i,
                    day: days[i-1],
                    date: Object.values(weekDates)[i-1] || ''
                });
            }
            
            // X√°o tr·ªôn th·ª© t·ª±
            for(let i = cards.length - 1; i > 0; i--){
                const j = Math.floor(Math.random() * (i + 1));
                [cards[i], cards[j]] = [cards[j], cards[i]];
            }
            
            return cards;
        }

        function initializeCards() {
            if (cardsInitialized) return;
            
            // T√≠nh to√°n v√† hi·ªÉn th·ªã tu·∫ßn
            const triggerDate = getTriggerDateFromURL();
            weekDates = calculateWeekFromTriggerDate(triggerDate);
            weekRangeElement.textContent = weekDates.week_range;
            
            // T·∫°o cards
            const indexCards = generateIndexCards();
            indexCards.forEach(cardData => {
                const card = createCard(cardData);
                cardContainer.appendChild(card);
            });
            
            cardsInitialized = true;
            console.log('Cards initialized');
        }

        function lockCardsFinal() {
            document.querySelectorAll('.flip-card').forEach(card => {
                card.onclick = null;
                card.style.cursor = 'default';
            });
        }

        function handleCardClick(event) {
            const cardElement = event.currentTarget;
            if(cardElement.classList.contains('flipped') || cardElement.classList.contains('locked')) return;

            cardElement.classList.add('flipped');
            const innerCard = cardElement.querySelector('.flip-card-inner');
            document.querySelectorAll('.flip-card').forEach(card => card.classList.add('locked'));

            selectedIndex = parseInt(cardElement.getAttribute('data-index'));
            const selectedDay = cardElement.getAttribute('data-day');
            const selectedDate = cardElement.getAttribute('data-date');
            
            innerCard.classList.add('selected-card');

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            resultIndexElement.textContent = selectedIndex;
            resultDateElement.textContent = `${selectedDay} (${selectedDate})`;
            resultSection.classList.remove('hidden');

            // G·ª≠i k·∫øt qu·∫£ ƒë·∫øn n8n webhook
            const payload = {
                action: "lottery_selection",
                selected_index: selectedIndex,
                selected_day: selectedDay,
                selected_date: selectedDate,
                week_range: weekDates.week_range,
                user_id: telegramUser.id,
                user_first_name: telegramUser.first_name,
                user_last_name: telegramUser.last_name,
                user_username: telegramUser.username,
                user_language: telegramUser.language_code,
                user_is_premium: telegramUser.is_premium,
                trigger_date: getTriggerDateFromURL().toISOString(),
                timestamp: new Date().toISOString(),
                source: 'telegram_web_app'
            };

            // Hi·ªÉn th·ªã loading
            messageBox.classList.remove('text-blue-700', 'bg-blue-100');
            messageBox.classList.add('text-yellow-700', 'bg-yellow-100');
            messageBox.innerHTML = `‚è≥ <b>ƒêANG G·ª¨I K·∫æT QU·∫¢...</b> Vui l√≤ng ch·ªù.`;

            fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.text();
            })
            .then(data => {
                console.log('Response from n8n webhook:', data);
                messageBox.classList.remove('text-yellow-700', 'bg-yellow-100');
                messageBox.classList.add('text-green-700', 'bg-green-100');
                messageBox.innerHTML = `‚úÖ <b>B·ªêC THƒÇM TH√ÄNH C√îNG!</b> Index <b>${selectedIndex}</b> - ${selectedDay} ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.`;
                
                // T·ª± ƒë·ªông ƒë√≥ng web app sau 3 gi√¢y
                setTimeout(() => {
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.close();
                    }
                }, 3000);
            })
            .catch(err => {
                console.error('L·ªói g·ª≠i webhook:', err);
                messageBox.classList.remove('text-yellow-700', 'bg-yellow-100');
                messageBox.classList.add('text-red-700', 'bg-red-100');
                messageBox.innerHTML = `‚ùå C√≥ l·ªói x·∫£y ra khi g·ª≠i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.`;
            });

            lockCardsFinal();
        }

        function createCard(cardData) {
            const card = document.createElement('div');
            card.className = 'flip-card';
            card.setAttribute('data-index', cardData.index);
            card.setAttribute('data-day', cardData.day);
            card.setAttribute('data-date', cardData.date);
            card.onclick = handleCardClick;

            card.innerHTML = `
                <div class="flip-card-inner">
                    <div class="flip-card-front">
                        <span class="text-7xl mb-2 font-bold transform -translate-y-2">?</span>
                        <span class="text-xl font-semibold">L·∫¨T TH·∫∫</span>
                        <span class="text-sm opacity-80 mt-1">Ch·ªçn index may m·∫Øn!</span>
                    </div>
                    <div class="flip-card-back">
                        <div class="flex flex-col items-center">
                            <span class="text-base font-medium text-gray-500">${cardData.day}</span>
                            <span class="text-6xl font-extrabold text-indigo-600">${cardData.index}</span>
                            <span class="text-lg font-semibold text-gray-700 mt-1">${cardData.date}</span>
                            <span class="text-xs text-green-600 mt-2">Index ƒë√£ ch·ªçn!</span>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
        async function initializeApp() {
            try {
                // 1. Kh·ªüi t·∫°o Telegram Web App tr∆∞·ªõc
                await initTelegramWebApp();
                
                // 2. Kh·ªüi t·∫°o cards sau khi Telegram ƒë√£ s·∫µn s√†ng
                initializeCards();
                
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Error initializing app:', error);
                // Fallback: v·∫´n kh·ªüi t·∫°o cards n·∫øu c√≥ l·ªói
                initializeCards();
            }
        }

        // B·∫Øt ƒë·∫ßu kh·ªüi t·∫°o khi DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
    </script>
</body>
</html>
