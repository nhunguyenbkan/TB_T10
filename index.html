<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minigame Ch·ªçn Ng√†y Tr·ª±c</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #ecf0f1;
            --card-width: 150px;
            --card-height: 200px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .flip-card {
            background-color: transparent;
            width: var(--card-width);
            height: var(--card-height);
            perspective: 1000px; /* T·∫°o hi·ªáu ·ª©ng 3D */
            transition: opacity 0.3s;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }

        /* Khi l·∫≠t th·∫ª */
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* ·∫®n m·∫∑t sau khi kh√¥ng l·∫≠t */
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        /* M·∫∑t tr∆∞·ªõc (Mystery Card) */
        .flip-card-front {
            background: linear-gradient(135deg, #2d338a 0%, #4f46e5 100%); /* Deep Blue/Purple */
            color: white;
            border: 4px solid #2d338a;
            user-select: none;
        }

        /* M·∫∑t sau (Date Reveal) */
        .flip-card-back {
            background-color: white;
            color: #374151;
            transform: rotateY(180deg);
            border: 4px solid #06b6d4; /* Cyan/Teal border */
            display: flex;
            padding: 1rem;
            justify-content: center;
            align-items: center; /* CƒÉn gi·ªØa l·∫°i n·ªôi dung */
        }

        /* Hi·ªÉn th·ªã tr√™n m√†n h√¨nh nh·ªè */
        @media (max-width: 640px) {
            :root {
                --card-width: 120px;
                --card-height: 160px;
            }
            .grid-cols-4 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        .selected-card {
            border: 4px solid #f97316; /* M√†u cam n·ªïi b·∫≠t khi ƒë∆∞·ª£c ch·ªçn */
            box-shadow: 0 0 25px rgba(249, 115, 22, 0.6); /* Th√™m hi·ªáu ·ª©ng ph√°t s√°ng */
        }

        /* Khi th·∫ª b·ªã kh√≥a (kh√¥ng c√≤n cho ph√©p click) */
        .flip-card.locked {
            pointer-events: none; /* Kh√≥a s·ª± ki·ªán click */
            cursor: default !important;
            opacity: 0.7; /* L√†m m·ªù ƒë·ªÉ b√°o hi·ªáu ƒë√£ b·ªã kh√≥a */
        }
        
        .flip-card:not(.locked) {
            cursor: pointer;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-start min-h-screen">

    <div class="max-w-4xl w-full">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">üé∞ Minigame L·∫≠t Th·∫ª Ch·ªçn Ng√†y Tr·ª±c</h1>
        <p class="text-center text-gray-500 mb-8">Click v√†o m·ªôt th·∫ª b·∫•t k·ª≥ ƒë·ªÉ ch·ªçn ng√†y. Thao t√°c n√†y s·∫Ω kh√≥a t·∫•t c·∫£ c√°c th·∫ª c√≤n l·∫°i v√† g·ª≠i ƒëƒÉng k√Ω ngay l·∫≠p t·ª©c.</p>
    </div>

    <!-- KHU V·ª∞C HI·ªÇN TH·ªä TH√îNG TIN USER -->
    <div class="w-full max-w-lg p-4 mb-6 bg-white border border-gray-200 rounded-xl shadow-lg mx-auto flex items-center space-x-4">
        <img id="user-avatar" class="w-12 h-12 rounded-full border-2 border-indigo-400" src="https://placehold.co/48x48/6366f1/ffffff?text=TG" alt="Avatar">
        <div>
            <span class="text-xs font-semibold text-gray-500">Ng∆∞·ªùi d√πng Telegram:</span>
            <p id="user-name" class="text-lg font-bold text-gray-800">ƒêang t·∫£i...</p>
        </div>
    </div>
    <!-- H·∫æT KHU V·ª∞C USER -->

    <!-- Container cho c√°c th·∫ª -->
    <div id="card-container" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-4 gap-4 sm:gap-6 md:gap-8 justify-center">
        <!-- Th·∫ª s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript t·∫°i ƒë√¢y -->
    </div>

    <!-- V√πng hi·ªÉn th·ªã k·∫øt qu·∫£ v√† th√¥ng b√°o -->
    <div class="mt-10 w-full max-w-lg p-6 bg-white border border-gray-200 rounded-xl shadow-lg mx-auto">
        <!-- Message box (D√πng ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i th√†nh c√¥ng/l·ªói) -->
        <div id="message-box" class="p-3 text-sm rounded-lg text-blue-700 bg-blue-100" role="alert">
            Click v√†o th·∫ª b·∫°n mu·ªën l·∫≠t ƒë·ªÉ b·∫Øt ƒë·∫ßu ch·ªçn ng√†y.
        </div>
    </div>

    <script>
        // C√°c bi·∫øn to√†n c·ª•c
        let selectedDate = null;
        let telegramUser = {
            id: 'mock_id_123',
            username: 'mock_user',
            first_name: 'Ng∆∞·ªùi d√πng'
        }; // Gi·∫£ ƒë·ªãnh th√¥ng tin user

        const cardContainer = document.getElementById('card-container');
        const messageBox = document.getElementById('message-box');
        const userNameElement = document.getElementById('user-name');
        const userAvatarElement = document.getElementById('user-avatar');

        // H√†m l·∫•y th√¥ng tin Telegram t·ª´ URL (m√¥ ph·ªèng)
        function getTelegramInitData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                
                const tgFirstName = urlParams.get('first_name') || 'Ng∆∞·ªùi d√πng Telegram';
                const tgUsername = urlParams.get('username');
                const tgId = urlParams.get('id') || 'N/A';
                const tgAvatarUrl = urlParams.get('avatar_url'); 

                if (tgId !== 'N/A') {
                    telegramUser.id = tgId;
                    telegramUser.first_name = tgFirstName;
                    telegramUser.username = tgUsername;
                    
                    userNameElement.textContent = tgFirstName + (tgUsername ? ` (@${tgUsername})` : '');
                    if (tgAvatarUrl) {
                        userAvatarElement.src = tgAvatarUrl;
                    }
                } else {
                    userNameElement.textContent = telegramUser.first_name + ' (Mock)';
                }
            } catch (e) {
                console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu Telegram Init:", e);
                userNameElement.textContent = telegramUser.first_name + ' (L·ªói t·∫£i)';
            }
        }

        // H√†m t·∫°o 7 ng√†y li√™n ti·∫øp
        function generateDates() {
            const days = ['Ch·ªß Nh·∫≠t', 'Th·ª© Hai', 'Th·ª© Ba', 'Th·ª© T∆∞', 'Th·ª© NƒÉm', 'Th·ª© S√°u', 'Th·ª© B·∫£y'];
            const dates = [];
            const now = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(now);
                date.setDate(now.getDate() + i);
                
                const dayOfWeek = days[date.getDay()];
                const dateOnly = date.getDate();
                const monthOnly = date.getMonth() + 1;
                const year = date.getFullYear();
                
                const fullDate = `${year}-${String(monthOnly).padStart(2, '0')}-${String(dateOnly).padStart(2, '0')}`;
                
                dates.push({
                    dayOfWeek,
                    dateOnly,
                    monthOnly,
                    year,
                    fullDate
                });
            }
            // Tr·ªôn ng·∫´u nhi√™n th·ª© t·ª± c√°c ng√†y
            for (let i = dates.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [dates[i], dates[j]] = [dates[j], dates[i]];
            }

            return dates;
        }

        // H√†m kh√≥a cu·ªëi c√πng
        function lockCardsFinal() {
            document.querySelectorAll('.flip-card').forEach(card => {
                card.onclick = null; 
                card.style.cursor = 'default'; 
            });
        }

        // H√†m x·ª≠ l√Ω khi m·ªôt th·∫ª ƒë∆∞·ª£c l·∫≠t/ch·ªçn (ONE-SHOT SELECTION & SUBMISSION)
        function handleCardClick(event) {
            let cardElement = event.currentTarget;

            // 1. N·∫øu th·∫ª ƒë√£ l·∫≠t ho·∫∑c ƒë√£ b·ªã kh√≥a th√¨ tho√°t
            if (cardElement.classList.contains('flipped') || cardElement.classList.contains('locked')) {
                return;
            }
            
            // 2. L·∫≠t th·∫ª hi·ªán t·∫°i
            cardElement.classList.add('flipped');
            const innerCard = cardElement.querySelector('.flip-card-inner');
            
            // 3. Kh√≥a T·∫§T C·∫¢ c√°c th·∫ª ngay l·∫≠p t·ª©c
            document.querySelectorAll('.flip-card').forEach(card => {
                card.classList.add('locked');
            });
            
            // 4. C·∫≠p nh·∫≠t tr·∫°ng th√°i ch·ªçn
            const dateValue = cardElement.getAttribute('data-date');
            const displayValue = cardElement.getAttribute('data-display');
            selectedDate = dateValue;
            innerCard.classList.add('selected-card');
            
            // 5. TH·ª∞C HI·ªÜN SUBMISSION NGAY L·∫¨P T·ª®C
            
            // G√ìI D·ªÆ LI·ªÜU ƒê·ªÇ G·ª¨I ƒê·∫æN N8N (M√¥ ph·ªèng)
            const payload = {
                action: "register_duty_day",
                date: selectedDate,
                user_id: telegramUser.id,
                user_name: telegramUser.first_name,
                full_telegram_info: JSON.stringify(telegramUser)
            };

            // G·ª≠i d·ªØ li·ªáu (M√¥ ph·ªèng)
            // Trong m√¥i tr∆∞·ªùng Web App Telegram TH·ª∞C T·∫æ, b·∫°n s·∫Ω d√πng:
            // Telegram.WebApp.sendData(JSON.stringify(payload)); 
            
            // Trong m√¥i tr∆∞·ªùng ƒë·ªôc l·∫≠p (m√¥ ph·ªèng):
            messageBox.classList.remove('text-blue-700', 'bg-blue-100');
            messageBox.classList.add('text-green-700', 'bg-green-100');
            messageBox.innerHTML = `‚úÖ **ƒêƒÇNG K√ù TH√ÄNH C√îNG!** B·∫°n ƒë√£ ch·ªçn ng√†y <b>${displayValue}</b>.<br>D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c g·ª≠i v·ªÅ bot Telegram ƒë·ªÉ ghi v√†o Google Sheet.`;
            
            // Kh√≥a cu·ªëi c√πng (lo·∫°i b·ªè handler)
            lockCardsFinal();

            console.log("ƒê√£ ƒëƒÉng k√Ω v√† g·ª≠i d·ªØ li·ªáu:", payload);
        }

        // H√†m t·∫°o HTML cho th·∫ª
        function createCard(dateData) {
            const card = document.createElement('div');
            
            card.className = 'flip-card';
            card.setAttribute('data-date', dateData.fullDate);
            card.setAttribute('data-display', `${dateData.dayOfWeek}, ${dateData.dateOnly}/${dateData.monthOnly}/${dateData.year}`);
            card.onclick = handleCardClick;

            card.innerHTML = `
                <div class="flip-card-inner">
                    <div class="flip-card-front">
                        <span class="text-7xl mb-2 font-bold transform -translate-y-2">?</span>
                        <span class="text-xl font-semibold">L·∫¨T TH·∫∫</span>
                        <span class="text-sm opacity-80 mt-1">Ch·ªçn ng√†y may m·∫Øn!</span>
                    </div>
                    <div class="flip-card-back">
                        <div class="flex flex-col items-center">
                            <span class="text-base font-medium text-gray-500">${dateData.dayOfWeek}</span>
                            <span class="text-6xl font-extrabold text-indigo-600">${dateData.dateOnly}</span>
                            <span class="text-xl font-semibold text-gray-700 mt-1">${dateData.monthOnly}/${dateData.year}</span>
                            <span class="text-xs text-green-600 mt-2">Ng√†y ƒë√£ ch·ªçn!</span>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }
        
        // Kh·ªüi t·∫°o Game
        window.onload = function() {
            getTelegramInitData(); // L·∫•y th√¥ng tin user
            
            const dates = generateDates(); 
            dates.forEach((dateData) => {
                const card = createCard(dateData);
                cardContainer.appendChild(card);
            });
        };

    </script>
</body>
</html>